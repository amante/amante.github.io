<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Promedios de Equipos NFL</title>
  <style>
    :root{--bg:#0b1220;--card:#121a2b;--muted:#7b88a8;--text:#e8eefc;--acc:#4ea1ff;--danger:#ff6b6b;--ok:#54d28a}
    *{box-sizing:border-box}
    body{margin:0;font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Noto Sans, Arial; background:linear-gradient(180deg,#0b1220,#0e1526 60%,#0b1220); color:var(--text)}
    header{padding:20px 16px; position:sticky; top:0; backdrop-filter: blur(8px); background: rgba(11,18,32,.7); border-bottom:1px solid rgba(255,255,255,.06); z-index:10}
    h1{margin:0;font-size: clamp(18px, 2.6vw, 28px); letter-spacing:.5px}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    .grid{display:grid; gap:16px}
    @media (min-width: 1000px){.grid{grid-template-columns: 380px 1fr}}
    .card{background:var(--card); border:1px solid rgba(255,255,255,.06); border-radius:18px; padding:16px; box-shadow: 0 10px 30px rgba(0,0,0,.25)}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .row3{display:grid; grid-template-columns: repeat(3, 1fr); gap:10px}
    label{font-size:12px;color:var(--muted)}
    input{width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.08); background:#0c1322; color:var(--text)}
    input::placeholder{color:#7884a3}
    .btns{display:flex; gap:10px; flex-wrap:wrap}
    button{cursor:pointer; border:1px solid rgba(255,255,255,.08); background:#0f1730; color:var(--text); padding:10px 14px; border-radius:12px}
    button.primary{background:linear-gradient(180deg,#1f54ff,#1b46cc); border-color:#1d4ed8}
    button.ghost{background:transparent}
    button.danger{background:#2a1418; border-color:#63222a; color:#ff9aa8}
    .toolbar{display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:10px; flex-wrap:wrap}
    .search{flex:1; min-width:220px}
    table{width:100%; border-collapse: collapse; overflow:hidden; border-radius:14px}
    thead th{position:sticky; top:0; background:#0e172c; color:#c8d4f8; text-align:left; font-weight:600; font-size:12px; letter-spacing:.3px; padding:10px; border-bottom:1px solid rgba(255,255,255,.06); cursor:pointer}
    tbody td{padding:10px; border-bottom:1px dashed rgba(255,255,255,.06); font-size:14px; color:#e9efff}
    tbody tr:hover{background: rgba(255,255,255,.03)}
    .pill{font-size:12px; padding:4px 8px; border-radius:999px; background:#0f2038; border:1px solid rgba(255,255,255,.08)}
    .right{display:flex; gap:8px; align-items:center}
    footer{opacity:.7; text-align:center; padding:20px}
    .hint{color:var(--muted); font-size:12px}
    .file{display:none}
    .nowrap{white-space:nowrap}
  </style>
</head>
<body>
  <header>
    <div class="container" style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap">
      <h1>üìä Promedios de Equipos NFL</h1>
      <div class="right">
        <button id="exportCSV" title="Exportar CSV">Exportar CSV</button>
        <label class="pill" for="importFile" style="cursor:pointer">Importar CSV</label>
        <input id="importFile" class="file" type="file" accept=".csv" />
        <button id="clearAll" class="danger" title="Borrar todo">Borrar todo</button>
      </div>
    </div>
  </header>

  <main class="container grid">
    <!-- Formulario -->
    <section class="card">
      <h2 style="margin:4px 0 12px 0">Agregar / Editar equipo</h2>
      <div class="row">
        <div>
          <label>Equipo</label>
          <input id="team" placeholder="Ej: Kansas City Chiefs" />
        </div>
        <div>
          <label>Divisi√≥n (opcional)</label>
          <input id="division" placeholder="Ej: AFC West" />
        </div>
      </div>
      <p class="hint" style="margin:10px 0 2px">Ofensiva (por partido)</p>
      <div class="row3">
        <div>
          <label>PTS</label>
          <input id="off_pts" type="number" step="0.1" placeholder="Ej: 24.7" />
        </div>
        <div>
          <label>YDS</label>
          <input id="off_yds" type="number" step="0.1" placeholder="Ej: 365.8" />
        </div>
        <div>
          <label>1st Downs</label>
          <input id="off_fd" type="number" step="0.1" placeholder="Ej: 21.9" />
        </div>
      </div>
      <div class="row3">
        <div>
          <label>YDS Carrera</label>
          <input id="off_rush" type="number" step="0.1" placeholder="Ej: 119.3" />
        </div>
        <div>
          <label>YDS Pase</label>
          <input id="off_pass" type="number" step="0.1" placeholder="Ej: 246.5" />
        </div>
        <div>
          <label>3rd Down %</label>
          <input id="off_3rd" type="number" step="0.1" placeholder="Ej: 41.3" />
        </div>
      </div>

      <p class="hint" style="margin:10px 0 2px">Defensiva (por partido)</p>
      <div class="row3">
        <div>
          <label>PTS Permitidos</label>
          <input id="def_pts" type="number" step="0.1" placeholder="Ej: 20.4" />
        </div>
        <div>
          <label>YDS Permitidos</label>
          <input id="def_yds" type="number" step="0.1" placeholder="Ej: 331.2" />
        </div>
        <div>
          <label>Sacks por juego</label>
          <input id="def_sacks" type="number" step="0.1" placeholder="Ej: 2.8" />
        </div>
      </div>
      <div class="row3">
        <div>
          <label>YDS Carrera Permitidos</label>
          <input id="def_rush" type="number" step="0.1" placeholder="Ej: 104.8" />
        </div>
        <div>
          <label>YDS Pase Permitidos</label>
          <input id="def_pass" type="number" step="0.1" placeholder="Ej: 226.4" />
        </div>
        <div>
          <label>Takeaways por juego</label>
          <input id="def_ta" type="number" step="0.1" placeholder="Ej: 1.3" />
        </div>
      </div>

      <div class="btns" style="margin-top:12px">
        <button class="primary" id="saveBtn">Guardar / Actualizar</button>
        <button class="ghost" id="resetBtn">Limpiar</button>
      </div>
      <p class="hint" style="margin-top:10px">Consejo: usa comas o puntos, se convierte autom√°ticamente. Los datos se guardan en tu navegador (LocalStorage).</p>
    </section>

    <!-- Comparador de Partidos -->
    <section class="card">
      <h2 style="margin:4px 0 12px 0">Crear partido y comparar equipos</h2>
      <div class="row">
        <div>
          <label>Equipo A</label>
          <select id="match_team_a"></select>
        </div>
        <div>
          <label>Equipo B</label>
          <select id="match_team_b"></select>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Fecha (opcional)</label>
          <input id="match_date" type="date" />
        </div>
        <div>
          <label>Sede (opcional)</label>
          <input id="match_site" placeholder="Ciudad / Estadio" />
        </div>
      </div>
      <div class="btns" style="margin-top:12px">
        <button class="primary" id="compareBtn">Comparar</button>
        <button id="saveMatchBtn">Guardar partido</button>
      </div>

      <div id="compareOut" style="margin-top:14px"></div>
    </section>

    <!-- Tabla equipos -->
    <section class="card">
      <div class="toolbar">
        <input class="search" id="search" placeholder="Buscar equipo o divisi√≥n..." />
        <div class="right">
          <span class="pill nowrap" id="count">0 equipos</span>
        </div>
      </div>

      <div style="overflow:auto">
        <table id="table">
          <thead>
            <tr>
              <th data-key="team">Equipo ‚¨ç</th>
              <th data-key="division">Divisi√≥n ‚¨ç</th>
              <th data-key="off_pts" title="Puntos por partido">PTS</th>
              <th data-key="off_yds" title="Yardas por partido">YDS</th>
              <th data-key="off_rush" title="Yardas por tierra">Rush</th>
              <th data-key="off_pass" title="Yardas por pase">Pass</th>
              <th data-key="def_pts" title="Puntos permitidos">PTS A</th>
              <th data-key="def_yds" title="Yardas permitidas">YDS A</th>
              <th>Rating</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Historial de partidos -->
    <section class="card">
      <h2 style="margin:4px 0 12px 0">Partidos guardados</h2>
      <div style="overflow:auto">
        <table id="matchesTable">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Partido</th>
              <th>Sede</th>
              <th>Resumen</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer>
    <small class="hint">Hecho con ‚ù§Ô∏è para fans de la NFL. ‚Äî Guarda/edita equipos, ord√©nalos y exporta/importa CSV.</small>
  </footer>

  <script>
    const $ = (sel)=>document.querySelector(sel);
    const $$ = (sel)=>Array.from(document.querySelectorAll(sel));

    const fields = ["team","division","off_pts","off_yds","off_fd","off_rush","off_pass","off_3rd","def_pts","def_yds","def_sacks","def_rush","def_pass","def_ta"]; 

    const state = {
      items: [],
      matches: [],
      sortKey: 'team',
      sortDir: 'asc',
      editingId: null,
    };

    const STORAGE_KEY = 'nfl_team_averages_v1'; // equipos (legacy)
    const MATCHES_KEY = 'nfl_matches_v1';

    function load(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        state.items = raw? JSON.parse(raw): [];
      }catch(err){ state.items = []; }
      try{
        const mraw = localStorage.getItem(MATCHES_KEY);
        state.matches = mraw? JSON.parse(mraw): [];
      }catch(err){ state.matches = []; }
    }
    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state.items)); }
    function saveMatches(){ localStorage.setItem(MATCHES_KEY, JSON.stringify(state.matches)); }

    function toNum(v){ if(v===''||v==null) return null; v = String(v).replace(',','.'); const n = Number(v); return Number.isFinite(n)? n : null; }

    function readForm(){
      const obj = {};
      for(const f of fields){
        const el = $('#'+f);
        if(!el) continue;
        obj[f] = (f.startsWith('off_')||f.startsWith('def_'))? toNum(el.value): el.value.trim();
      }
      obj.id = state.editingId || crypto.randomUUID();
      obj.createdAt = state.editingId? state.items.find(x=>x.id===obj.id)?.createdAt : Date.now();
      obj.updatedAt = Date.now();
      obj.rating = computeRating(obj);
      return obj;
    }

    function fillForm(it){
      for(const f of fields){ const el = $('#'+f); if(!el) continue; el.value = (it?.[f] ?? '') }
    }

    function resetForm(){ state.editingId=null; fillForm({}); $('#team').focus(); }

    function upsert(item){
      const idx = state.items.findIndex(x=>x.id===item.id);
      if(idx>=0) state.items[idx]=item; else state.items.push(item);
      save();
      render();
      resetForm();
    }

    function remove(id){ state.items = state.items.filter(x=>x.id!==id); save(); render(); renderMatchSelectors(); }

    function computeRating(o){
      // Sencillo rating ofensivo-defensivo normalizado
      const off = avg([o.off_pts, o.off_yds/10, o.off_rush/2, o.off_pass/3, (o.off_3rd??0)]);
      const def = avg([-(o.def_pts??0), -(o.def_yds??0)/10, -(o.def_rush??0)/2, -(o.def_pass??0)/3, (o.def_ta??0)*3, (o.def_sacks??0)*2]);
      if(off==null && def==null) return null;
      const score = ( (off||0) + (def||0) );
      return Math.round(score*10)/10;
    }
    function avg(arr){
      const vals = arr.map(x=>typeof x==='number' && Number.isFinite(x)? x: null).filter(x=>x!=null);
      if(!vals.length) return null; return vals.reduce((a,b)=>a+b,0)/vals.length;
    }

    function sortBy(key){
      if(state.sortKey===key) state.sortDir = state.sortDir==='asc'?'desc':'asc';
      else{ state.sortKey=key; state.sortDir='asc'; }
      render();
    }

    function render(){
      const q = $('#search')?.value.trim().toLowerCase() || '';
      let rows = state.items.filter(it=> !q || it.team?.toLowerCase().includes(q) || it.division?.toLowerCase().includes(q));
      const dir = state.sortDir==='asc'? 1 : -1;
      rows.sort((a,b)=>{
        const ka = a[state.sortKey]; const kb = b[state.sortKey];
        if(ka==null && kb==null) return 0; if(ka==null) return 1; if(kb==null) return -1;
        if(typeof ka==="number" && typeof kb==="number") return (ka-kb)*dir;
        return String(ka).localeCompare(String(kb))*dir;
      });

      const tbody = $('#table tbody');
      if(tbody){
        tbody.innerHTML = rows.map(it=> `
          <tr>
            <td>${escapeHTML(it.team||'')}</td>
            <td class="hint">${escapeHTML(it.division||'')}</td>
            <td>${fmt(it.off_pts)}</td>
            <td>${fmt(it.off_yds)}</td>
            <td>${fmt(it.off_rush)}</td>
            <td>${fmt(it.off_pass)}</td>
            <td>${fmt(it.def_pts)}</td>
            <td>${fmt(it.def_yds)}</td>
            <td><span class="pill">${it.rating==null?'-':it.rating}</span></td>
            <td class="nowrap">
              <button title="Editar" onclick="app.edit('${it.id}')">‚úèÔ∏è</button>
              <button class="danger" title="Eliminar" onclick="app.del('${it.id}')">üóëÔ∏è</button>
              <button title="Comparar" onclick="app.quickCompare('${it.id}')">‚öñÔ∏è</button>
            </td>
          </tr>
        `).join('');
      }

      const c = $('#count'); if(c) c.textContent = `${rows.length} ${rows.length===1?'equipo':'equipos'}`;

      // headers click sort
      $$('th[data-key]').forEach(th=> th.onclick = ()=> sortBy(th.dataset.key));

      renderMatchSelectors();
      renderMatchesTable();
    }

    function escapeHTML(s){ return String(s).replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]) ); }
    function fmt(n){ return (n==null||!Number.isFinite(n))? '-' : Number(n).toFixed(1); }

    // ===================== PARTIDOS / COMPARADOR =====================
    function renderMatchSelectors(){
      const a = $('#match_team_a'); const b = $('#match_team_b');
      if(!a || !b) return;
      const opts = ['<option value="">Selecciona equipo...</option>']
        .concat(state.items
          .slice().sort((x,y)=> x.team.localeCompare(y.team))
          .map(it=> `<option value="${it.id}">${escapeHTML(it.team)}</option>`));
      a.innerHTML = opts.join('');
      b.innerHTML = opts.join('');
    }

    function getTeamById(id){ return state.items.find(t=>t.id===id); }

    // ===== Modelo de probabilidad (heur√≠stico) =====
    function leagueStats(keys){
      // Calcula media y desv√≠o est√°ndar para las m√©tricas disponibles
      const items = state.items;
      const means = {}; const stds = {};
      for(const k of keys){
        const vals = items.map(it=> it[k]).filter(v=> typeof v==='number' && Number.isFinite(v));
        const mean = vals.length? vals.reduce((a,b)=>a+b,0)/vals.length : 0;
        const variance = vals.length? vals.reduce((a,b)=> a + Math.pow(b-mean,2), 0) / vals.length : 0;
        means[k] = mean; stds[k] = Math.sqrt(variance) || 1; // evita divisi√≥n por 0
      }
      return {means, stds};
    }

    function z(v, mean, sd){ if(v==null || !Number.isFinite(v)) return 0; return (v-mean)/ (sd || 1); }

    function modelScore(A,B){
      // Definimos m√©tricas: para defensa usamos el signo para que "m√°s alto = mejor"
      const KEYS = ['rating','off_pts','off_yds','off_rush','off_pass','off_3rd','def_pts','def_yds','def_rush','def_pass','def_sacks','def_ta'];
      const {means, stds} = leagueStats(KEYS);
      const featA = {
        rating: z(A.rating??0, means.rating, stds.rating),
        off_pts: z(A.off_pts, means.off_pts, stds.off_pts),
        off_yds: z(A.off_yds, means.off_yds, stds.off_yds),
        off_rush: z(A.off_rush, means.off_rush, stds.off_rush),
        off_pass: z(A.off_pass, means.off_pass, stds.off_pass),
        off_3rd: z(A.off_3rd, means.off_3rd, stds.off_3rd),
        def_pts: -z(A.def_pts, means.def_pts, stds.def_pts), // menos puntos permitidos = mejor
        def_yds: -z(A.def_yds, means.def_yds, stds.def_yds),
        def_rush: -z(A.def_rush, means.def_rush, stds.def_rush),
        def_pass: -z(A.def_pass, means.def_pass, stds.def_pass),
        def_sacks: z(A.def_sacks, means.def_sacks, stds.def_sacks),
        def_ta: z(A.def_ta, means.def_ta, stds.def_ta),
      };
      const featB = {
        rating: z(B.rating??0, means.rating, stds.rating),
        off_pts: z(B.off_pts, means.off_pts, stds.off_pts),
        off_yds: z(B.off_yds, means.off_yds, stds.off_yds),
        off_rush: z(B.off_rush, means.off_rush, stds.off_rush),
        off_pass: z(B.off_pass, means.off_pass, stds.off_pass),
        off_3rd: z(B.off_3rd, means.off_3rd, stds.off_3rd),
        def_pts: -z(B.def_pts, means.def_pts, stds.def_pts),
        def_yds: -z(B.def_yds, means.def_yds, stds.def_yds),
        def_rush: -z(B.def_rush, means.def_rush, stds.def_rush),
        def_pass: -z(B.def_pass, means.def_pass, stds.def_pass),
        def_sacks: z(B.def_sacks, means.def_sacks, stds.def_sacks),
        def_ta: z(B.def_ta, means.def_ta, stds.def_ta),
      };
      // Pesos heur√≠sticos (suman ~5.0) ‚Äî puedes ajustarlos
      const W = {
        rating: 1.2,
        off_pts: 0.8,
        off_yds: 0.4,
        off_rush: 0.2,
        off_pass: 0.2,
        off_3rd: 0.3,
        def_pts: 0.8,
        def_yds: 0.4,
        def_rush: 0.2,
        def_pass: 0.2,
        def_sacks: 0.3,
        def_ta: 0.3,
      };
      let score=0;
      for(const k in W){ score += W[k] * ((featA[k]||0) - (featB[k]||0)); }
      // Escala suave para evitar extremos con pocos datos
      const scale = 0.9;
      return score * scale;
    }

    function sigmoid(x){ return 1/(1+Math.exp(-x)); }

    function modelProbabilities(A,B){
      const s = modelScore(A,B);
      const pA = sigmoid(s);
      const pB = 1 - pA;
      return {pA, pB, score:s};
    }

    function compareTeams(A,B){
      if(!A || !B) return null;
      const metrics = [
        {k:'rating', label:'Rating (calc)', higherIsBetter:true},
        {k:'off_pts', label:'PTS (ofensiva)', higherIsBetter:true},
        {k:'off_yds', label:'YDS (ofensiva)', higherIsBetter:true},
        {k:'off_rush', label:'YDS Carrera (of)', higherIsBetter:true},
        {k:'off_pass', label:'YDS Pase (of)', higherIsBetter:true},
        {k:'off_3rd', label:'3rd Down %', higherIsBetter:true},
        {k:'def_pts', label:'PTS Permitidos', higherIsBetter:false},
        {k:'def_yds', label:'YDS Permitidos', higherIsBetter:false},
        {k:'def_rush', label:'Rush Permitidos', higherIsBetter:false},
        {k:'def_pass', label:'Pass Permitidos', higherIsBetter:false},
        {k:'def_sacks', label:'Sacks por juego', higherIsBetter:true},
        {k:'def_ta', label:'Takeaways por juego', higherIsBetter:true},
      ];
      let scoreA=0, scoreB=0;
      const rows = metrics.map(m=>{
        const va = A[m.k]; const vb = B[m.k];
        const better = (va==null||!Number.isFinite(va)) && (vb==null||!Number.isFinite(vb))? '':
          (m.higherIsBetter? (va>vb? 'A': (vb>va? 'B':'=')) : (va<vb? 'A': (vb<va? 'B':'=')));
        if(better==='A') scoreA++; else if(better==='B') scoreB++;
        const diff = (va==null || vb==null)? null : Math.round((va - vb)*10)/10;
        return {label:m.label, va, vb, better, diff};
      });
      const probs = modelProbabilities(A,B);
      return {rows, scoreA, scoreB, probs};
    }

    function renderComparison(){
      const out = $('#compareOut'); if(!out) return;
      const aId = $('#match_team_a').value; const bId = $('#match_team_b').value;
      const A = getTeamById(aId); const B = getTeamById(bId);
      if(!A || !B){ out.innerHTML = '<p class="hint">Selecciona Equipo A y Equipo B y pulsa <b>Comparar</b>.</p>'; return; }
      const cmp = compareTeams(A,B);
      const badge = (w)=> w==='A'? 'style="background:#0f2a1a;border-color:#1f5c3b"' : w==='B'? 'style="background:#2a1a0f;border-color:#5c3b1f"' : '';
      const pct = (x)=> (x*100).toFixed(1)+'%';
      out.innerHTML = `
        <div class="row" style="margin-bottom:10px">
          <div class="pill" style="display:flex; gap:8px; align-items:center; justify-content:center">üèà <b>${escapeHTML(A.team)}</b></div>
          <div class="pill" style="display:flex; gap:8px; align-items:center; justify-content:center">üèà <b>${escapeHTML(B.team)}</b></div>
        </div>

        <div class="card" style="background:#0e172c;border:1px solid rgba(255,255,255,.06);margin-bottom:12px">
          <div class="row" style="align-items:center">
            <div>
              <div class="hint" style="margin-bottom:6px">Probabilidad de victoria (modelo por promedios)</div>
              <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; align-items:center">
                <div><b>${escapeHTML(A.team)}</b></div>
                <div style="text-align:right"><b>${escapeHTML(B.team)}</b></div>
                <div style="grid-column:1/-1; height:14px; background:#0c1322; border-radius:999px; overflow:hidden; border:1px solid rgba(255,255,255,.08)">
                  <div style="height:100%; width:${(cmp.probs.pA*100).toFixed(1)}%; background:linear-gradient(90deg,#1f54ff,#54d28a)"></div>
                </div>
                <div>${pct(cmp.probs.pA)}</div>
                <div style="text-align:right">${pct(cmp.probs.pB)}</div>
              </div>
              <div class="hint" style="margin-top:6px">Nota: Heur√≠stico. Usa z-scores y pesos sobre PTS/YDS of/def, 3rd%, sacks, takeaways y un rating compuesto.</div>
            </div>
          </div>
        </div>

        <div style="overflow:auto">
          <table style="width:100%">
            <thead>
              <tr>
                <th>M√©trica</th>
                <th>${escapeHTML(A.team)}</th>
                <th>${escapeHTML(B.team)}</th>
                <th>Œî A‚àíB</th>
              </tr>
            </thead>
            <tbody>
              ${cmp.rows.map(r=>`
                <tr>
                  <td>${r.label}</td>
                  <td ${r.better==='A'?badge('A'):''}>${fmt(r.va)}</td>
                  <td ${r.better==='B'?badge('B'):''}>${fmt(r.vb)}</td>
                  <td class="hint">${r.diff==null?'-':r.diff}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
        <div class="btns" style="margin-top:10px">
          <span class="pill">Marcadores de m√©tricas: ${cmp.scoreA} ‚Äì ${cmp.scoreB}</span>
          <span class="pill">Pick sugerido: <b>${cmp.probs.pA>=cmp.probs.pB? escapeHTML(A.team): escapeHTML(B.team)}</b></span>
        </div>
      `;
    }

    function saveMatchFromUI(){
      const aId = $('#match_team_a').value; const bId = $('#match_team_b').value;
      const A = getTeamById(aId); const B = getTeamById(bId);
      if(!A || !B){ alert('Selecciona ambos equipos.'); return; }
      const date = $('#match_date').value || '';
      const site = $('#match_site').value.trim();
      const cmp = compareTeams(A,B);
      const p = cmp?.probs || {pA:0.5,pB:0.5};
      const pStr = `${(p.pA*100).toFixed(1)}%‚Äì${(p.pB*100).toFixed(1)}%`;
      const m = {
        id: crypto.randomUUID(),
        aId, bId, date, site,
        createdAt: Date.now(),
        summary: `${A.team} vs ${B.team} ‚Äî Prob: ${pStr}`
      };
      state.matches.unshift(m);
      saveMatches();
      renderMatchesTable();
    }

    function renderMatchesTable(){
      const tbody = $('#matchesTable tbody'); if(!tbody) return;
      if(!state.matches.length){ tbody.innerHTML = '<tr><td colspan="5" class="hint">No hay partidos guardados todav√≠a.</td></tr>'; return; }
      tbody.innerHTML = state.matches.map(m=>{
        const A = getTeamById(m.aId); const B = getTeamById(m.bId);
        const aName = A?.team || 'Equipo A'; const bName = B?.team || 'Equipo B';
        return `
          <tr>
            <td>${m.date?escapeHTML(m.date):'<span class="hint">‚Äì</span>'}</td>
            <td>${escapeHTML(aName)} vs ${escapeHTML(bName)}</td>
            <td>${m.site?escapeHTML(m.site):'<span class="hint">‚Äì</span>'}</td>
            <td>${escapeHTML(m.summary||'')}</td>
            <td class="nowrap">
              <button onclick="app.loadMatch('${m.id}')">Ver</button>
              <button class="danger" onclick="app.delMatch('${m.id}')">Eliminar</button>
            </td>
          </tr>`;
      }).join('');
    }

    const app = {
      edit(id){
        const it = state.items.find(x=>x.id===id); if(!it) return;
        state.editingId = id; fillForm(it);
        window.scrollTo({top:0,behavior:'smooth'});
      },
      del(id){ if(confirm('¬øEliminar equipo?')) remove(id); },
      quickCompare(id){
        const a = $('#match_team_a'); const b = $('#match_team_b');
        if(!a || !b) return;
        if(!a.value) a.value = id; else b.value = id;
        renderComparison();
        window.scrollTo({top: document.body.scrollHeight/3, behavior:'smooth'});
      },
      loadMatch(id){
        const m = state.matches.find(x=>x.id===id); if(!m) return;
        $('#match_team_a').value = m.aId; $('#match_team_b').value = m.bId;
        $('#match_date').value = m.date||''; $('#match_site').value = m.site||'';
        renderComparison();
      },
      delMatch(id){ if(confirm('¬øEliminar partido guardado?')){ state.matches = state.matches.filter(x=>x.id!==id); saveMatches(); renderMatchesTable(); }}
    };
    window.app = app;

    // Events
    $('#saveBtn').onclick = ()=>{
      const obj = readForm();
      if(!obj.team){ alert('Ingresa el nombre del equipo'); $('#team').focus(); return; }
      upsert(obj);
    };
    $('#resetBtn').onclick = resetForm;
    const s = $('#search'); if(s) s.oninput = render;
    $('#exportCSV').onclick = ()=> download('nfl_promedios.csv', toCSV(state.items));
    $('#clearAll').onclick = ()=>{ if(confirm('Esto borrar√° todos los equipos guardados en este navegador.')){ state.items=[]; save(); render(); } };
    $('#importFile').addEventListener('change', async (e)=>{
      const file = e.target.files[0]; if(!file) return;
      const text = await file.text();
      const newItems = parseCSV(text);
      state.items = dedupByName(state.items.concat(newItems));
      save(); render(); e.target.value='';
    });

    $('#compareBtn').onclick = renderComparison;
    $('#saveMatchBtn').onclick = saveMatchFromUI;

    function dedupByName(arr){
      const map = new Map();
      for(const it of arr){ map.set((it.team||'').toLowerCase(), it); }
      return Array.from(map.values());
    }

    function toCSV(items){
      const cols = ['team','division','off_pts','off_yds','off_fd','off_rush','off_pass','off_3rd','def_pts','def_yds','def_sacks','def_rush','def_pass','def_ta','rating'];
      const head = cols.join(',');
      const body = items.map(it=> cols.map(k=> {
        const v = it[k];
        if(v==null) return '';
        const s = typeof v==='number'? v : String(v).replaceAll('"','""');
        return /[",]/.test(String(s))? `"${s}"` : s;
      }).join(',')).join('');
      return head+''+body;
    }

    function download(filename, text){
      const blob = new Blob([text], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    function parseCSV(text){
      // Muy simple parser para CSV con comillas
      const lines = text.split(/?/).filter(l=>l.trim().length);
      const head = splitCSVLine(lines.shift());
      const rows = lines.map(splitCSVLine);
      const idx = (k)=> head.indexOf(k);
      const out = rows.map(r=>{
        const obj = {};
        for(const f of fields){
          const i = idx(f);
          if(i<0) continue;
          let v = r[i] ?? '';
          if(f.startsWith('off_')||f.startsWith('def_')) obj[f] = toNum(v); else obj[f] = v;
        }
        obj.id = crypto.randomUUID();
        obj.createdAt = Date.now();
        obj.updatedAt = Date.now();
        obj.rating = computeRating(obj);
        return obj;
      });
      return out;
    }
    function splitCSVLine(line){
      const res=[]; let cur=''; let inQ=false; for(let i=0;i<line.length;i++){
        const ch=line[i];
        if(inQ){
          if(ch==='"' && line[i+1]==='"'){ cur+='"'; i++; }
          else if(ch==='"'){ inQ=false; }
          else cur+=ch;
        } else {
          if(ch==='"'){ inQ=true; }
          else if(ch===','){ res.push(cur); cur=''; }
          else cur+=ch;
        }
      }
      res.push(cur); return res;
    }

    // init
    load();
    render();
  // init END
    load();
    render();
  </script>
</body>
</html>
